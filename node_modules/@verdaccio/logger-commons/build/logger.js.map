{"version":3,"file":"logger.js","names":["_colorette","require","_debug","_interopRequireDefault","_loggerPrettify","e","__esModule","default","debug","buildDebug","isProd","process","env","NODE_ENV","hasColors","colors","isColorSupported","DEFAULT_LOG_FORMAT","createLogger","options","level","destination","pino","format","pinoConfig","customLevels","http","serializers","err","stdSerializers","req","res","includes","Object","assign","transport","target","path","prettyStamp","hooks","logMethod","inputArgs","method","templateObject","message","otherArgs","templateVars","getOwnPropertyNames","length","apply","hydratedMessage","fillInMsgTemplate","logger","DEBUG","on","lvl","val","prevLvl","prevVal","instance","DEFAULT_LOGGER_CONF","type","prepareSetup","loggerConfig","reopen","exports","setup"],"sources":["../src/logger.ts"],"sourcesContent":["// <reference types=\"node\" />\nimport { isColorSupported } from 'colorette';\nimport buildDebug from 'debug';\n\nimport { fillInMsgTemplate } from '@verdaccio/logger-prettify';\nimport { Logger, LoggerConfigItem, LoggerFormat } from '@verdaccio/types';\n\nconst debug = buildDebug('verdaccio:logger');\n\nfunction isProd() {\n  return process.env.NODE_ENV === 'production';\n}\n\nfunction hasColors(colors: boolean | undefined) {\n  if (colors) {\n    return isColorSupported;\n  }\n  return typeof colors === 'undefined' ? true : colors;\n}\n\nconst DEFAULT_LOG_FORMAT = isProd() ? 'json' : 'pretty';\n\nexport type LogPlugin = {\n  dest: string;\n  options?: any[];\n};\n\ntype LoggerOptions = { level?: string; path?: string; colors?: boolean; sync?: boolean };\n\nexport function createLogger(\n  options: LoggerOptions = { level: 'http' },\n  // eslint-disable-next-line no-undef\n  // @ts-ignore\n  destination: NodeJS.WritableStream = pino.destination(1),\n  format: LoggerFormat = DEFAULT_LOG_FORMAT,\n  pino\n): any {\n  debug('setup logger');\n  let pinoConfig = {\n    customLevels: {\n      http: 25,\n    },\n    level: options.level,\n    serializers: {\n      err: pino.stdSerializers.err,\n      req: pino.stdSerializers.req,\n      res: pino.stdSerializers.res,\n    },\n  };\n\n  debug('has prettifier? %o', !isProd());\n  // pretty logs are not allowed in production for performance reasons\n  if (['pretty-timestamped', 'pretty'].includes(format) && isProd() === false) {\n    pinoConfig = Object.assign({}, pinoConfig, {\n      transport: {\n        target: '@verdaccio/logger-prettify',\n        options: {\n          // string or 1 (file descriptor for process.stdout)\n          destination: options.path || 1,\n          colors: hasColors(options.colors),\n          prettyStamp: format === 'pretty-timestamped',\n        },\n      },\n    });\n  } else {\n    pinoConfig = {\n      ...pinoConfig,\n      // more info\n      // https://github.com/pinojs/pino/blob/v7.1.0/docs/api.md#hooks-object\n      // TODO: improve typings here\n      // @ts-ignore\n      hooks: {\n        logMethod(\n          inputArgs: [any, any, ...any[]],\n          method: {\n            apply: (arg0: { logMethod: (inputArgs: any, method: any) => any }, arg1: any[]) => any;\n          }\n        ) {\n          const [templateObject, message, ...otherArgs] = inputArgs;\n          const templateVars =\n            !!templateObject && typeof templateObject === 'object'\n              ? Object.getOwnPropertyNames(templateObject)\n              : [];\n          if (!message || !templateVars.length) return method.apply(this, inputArgs);\n          const hydratedMessage = fillInMsgTemplate(message, templateObject, false);\n          return method.apply(this, [templateObject, hydratedMessage, ...otherArgs]);\n        },\n      },\n    };\n  }\n  const logger = pino(pinoConfig, destination);\n\n  /* eslint-disable */\n  /* istanbul ignore next */\n  if (process.env.DEBUG) {\n    logger.on('level-change', (lvl, val, prevLvl, prevVal, instance) => {\n      if (logger !== instance) {\n        return;\n      }\n      debug('%s (%d) was changed to %s (%d)', lvl, val, prevLvl, prevVal);\n    });\n  }\n\n  return logger;\n}\n\nconst DEFAULT_LOGGER_CONF: LoggerConfigItem = {\n  type: 'stdout',\n  format: 'pretty',\n  level: 'http',\n};\n\nexport type LoggerConfig = LoggerConfigItem;\n\nexport function prepareSetup(options: LoggerConfigItem = DEFAULT_LOGGER_CONF, pino) {\n  let logger: Logger;\n  let loggerConfig = options;\n  if (!loggerConfig?.level) {\n    loggerConfig = Object.assign(\n      {},\n      {\n        level: 'http',\n      },\n      loggerConfig\n    );\n  }\n  const pinoConfig = { level: loggerConfig.level };\n  if (loggerConfig.type === 'file') {\n    debug('logging file enabled');\n    const destination = pino.destination(loggerConfig.path);\n    /* eslint-disable */\n    /* istanbul ignore next */\n    process.on('SIGUSR2', () => destination.reopen());\n    // @ts-ignore\n    logger = createLogger(\n      { level: loggerConfig.level, path: loggerConfig.path, colors: loggerConfig.colors },\n      // @ts-ignore\n      destination,\n      loggerConfig.format,\n      pino\n    );\n    return logger;\n  } else {\n    debug('logging stdout enabled');\n    // @ts-ignore\n    logger = createLogger(\n      { level: loggerConfig.level, colors: loggerConfig.colors },\n      // @ts-ignore\n      pino.destination(1),\n      loggerConfig.format,\n      pino\n    );\n    return logger;\n  }\n}\n\nexport let logger: Logger;\n\nexport function setup(options: LoggerConfigItem, pino) {\n  if (typeof logger !== 'undefined') {\n    return logger;\n  }\n\n  logger = prepareSetup(options, pino);\n  return logger;\n}\n"],"mappings":"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","ignoreList":[]}