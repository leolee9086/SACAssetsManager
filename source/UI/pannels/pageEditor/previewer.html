<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      transition: zoom 0.3s ease;
    }
    .editor-component {
      box-sizing: border-box;
      min-width: 50px;
      min-height: 30px;
      transition: all 0.2s ease;
    }
    #app {
      width: 100%;
      min-height: 100vh;
      padding: 24px;
      box-sizing: border-box;
      max-width: 1200px;  /* é™åˆ¶æœ€å¤§å®½åº¦ */
      margin: 0 auto;     /* æ°´å¹³å±…ä¸­ */
      transition: max-width 0.3s ease;
    }
    
    /* ç»„ä»¶å®¹å™¨æ ·å¼ */
    .component-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;         /* ç»„ä»¶ä¹‹é—´çš„é—´è· */
    }
    
    /* ç»„ä»¶äº¤äº’æ ·å¼ */
    .editor-component:hover {
      outline: 2px solid #1890ff;
    }
    .editor-component.selected {
      outline: 2px solid #1890ff;
      box-shadow: 0 0 8px rgba(24, 144, 255, 0.2);
    }

    /* æ‹–æ‹½æ ·å¼ */
    #app.drag-over {
      background-color: rgba(24, 144, 255, 0.1);
    }

    /* æ·»åŠ ç»„ä»¶é«˜äº®æ ·å¼ */
    .editor-component.highlight {
        outline: 2px solid #1890ff;
        box-shadow: 0 0 8px rgba(24, 144, 255, 0.2);
    }

    /* æ·»åŠ è®¾å¤‡å“åº”å¼æ ·å¼ */
    #app {
        transition: max-width 0.3s ease;
        margin: 0 auto;
        width: 100%;
    }

    /* æ·»åŠ ç¼©æ”¾è¿‡æ¸¡æ•ˆæœ */
    body {
        transition: zoom 0.3s ease;
    }

    /* æ·»åŠ å¸ƒå±€å®¹å™¨æ ·å¼ */
    .editor-component[data-component-type="container"] {
      min-height: 100px;
      padding: 16px;
      border: 1px dashed #ddd;
      background: rgba(255, 255, 255, 0.8);
    }

    .editor-component[data-component-type="container"].drag-over {
      background: rgba(24, 144, 255, 0.1);
      border-color: #1890ff;
    }

    /* æ·»åŠ æ‹–æ‹½ç›®æ ‡ä½ç½®çš„é«˜äº®æ ·å¼ */
    .drop-target-before {
      border-top: 2px solid #1890ff !important;
    }
    
    .drop-target-after {
      border-bottom: 2px solid #1890ff !important;
    }
    
    .drop-target-inside {
      background: rgba(24, 144, 255, 0.1) !important;
      border: 2px solid #1890ff !important;
    }

    /* æ·»åŠ æ‹–æ‹½é¢„è§ˆå…ƒç´ æ ·å¼ */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.6;
      transform: translate(-50%, -50%);
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border-radius: 4px;
      padding: 8px;
    }

    /* æ·»åŠ æ‚¬æµ®èœå•æ ·å¼ */
    .hover-menu {
      position: absolute;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 4px;
      display: flex;
      gap: 4px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .hover-menu.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .hover-menu-item {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #333;
    }

    .hover-menu-item:hover {
      background: #f5f5f5;
    }

    /* ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºåœ¨ç»„ä»¶ä¸Šæ–¹ */
    .editor-mode .hover-menu {
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
    }

    /* é¢„è§ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºåœ¨å³ä¾§ */
    .preview-mode .hover-menu {
      top: 50%;
      right: -8px;
      transform: translate(100%, -50%);
    }

    /* æ·»åŠ å¯¼å‡ºæŒ‰é’®æ ·å¼ */
    .export-button {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1890ff;
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      border: none;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .export-button:hover {
      background: #40a9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .export-button:active {
      transform: translateY(0);
    }

    /* æ·»åŠ æ‹–æ‹½æŒ‡ç¤ºå™¨æ ·å¼ */
    .drop-indicator {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
      transition: all 0.2s ease;
    }

    .drop-indicator.horizontal {
      height: 2px;
      background: #1890ff;
      left: 0;
      right: 0;
    }

    .drop-indicator.vertical {
      width: 2px;
      background: #1890ff;
      top: 0;
      bottom: 0;
    }

    /* ä¿®æ”¹å®¹å™¨æ‹–æ‹½æ ·å¼ */
    .editor-component[data-component-type="container"].drag-over {
      background: rgba(24, 144, 255, 0.05);
      border: 2px dashed #1890ff;
    }
  </style>
  <script src="https://unpkg.com/petite-vue"></script>
</head>
<body>
  <div id="app" v-scope>
    <!-- ç»„ä»¶å°†è¢«åŠ¨æ€æ¸²æŸ“åˆ°è¿™é‡Œ -->
  </div>
  
  <button class="export-button" onclick="handleExport()">
    ğŸ“¤ å¯¼å‡ºé¡µï¿½ï¿½
  </button>

  <script type="module">
    import { componentConfigs } from './componentConfig.js';
    import { behaviors } from './componentConfig.js';
    
    const { createApp } = window.PetiteVue;
    
    // æ·»åŠ æ‚¬æµ®èœå•é…ç½®
    const hoverMenuConfig = {
      // é€šç”¨ç»„ä»¶é…ç½®
      default: {
        editMode: [
          {
            icon: 'âœï¸',
            label: 'ç¼–è¾‘',
            action: 'edit'
          },
          {
            icon: 'ğŸ—‘ï¸',
            label: 'åˆ é™¤',
            action: 'delete'
          }
        ],
        previewMode: [
          {
            icon: 'ğŸ‘ï¸',
            label: 'æŸ¥çœ‹',
            action: 'view'
          }
        ]
      },
      // å®¹å™¨ç»„ä»¶ç‰¹æ®Šé…ç½®
      container: {
        editMode: [
          {
            icon: 'âœï¸',
            label: 'ç¼–è¾‘',
            action: 'edit'
          },
          {
            icon: 'â•',
            label: 'æ·»åŠ ',
            action: 'add'
          },
          {
            icon: 'ğŸ—‘ï¸',
            label: 'åˆ é™¤',
            action: 'delete'
          }
        ],
        previewMode: [
          {
            icon: 'ğŸ‘ï¸',
            label: 'æŸ¥çœ‹',
            action: 'view'
          }
        ]
      }
    };

    // æ·»åŠ å…¨å±€çŠ¶æ€å˜ï¿½ï¿½ï¿½
    let selectedComponentId = null;

    // æ·»åŠ æ‹–æ‹½é¢„è§ˆå…ƒç´ å¤„ç†
    let dragGhost = null;

    // æ·»åŠ ç¼–è¾‘æ¨¡å¼çŠ¶æ€
    window.isPreviewMode = false;

    // æ·»åŠ æ‹–æ‹½æŒ‡ç¤ºå™¨
    let dropIndicator = null;

    function createDropIndicator() {
      if (!dropIndicator) {
        dropIndicator = document.createElement('div');
        dropIndicator.className = 'drop-indicator';
        document.body.appendChild(dropIndicator);
      }
      return dropIndicator;
    }

    function isValidDropTarget(element) {
      if (!element) return false;
      if (!element.classList.contains('editor-component')) return false;
      return true;
    }

    function getDropPosition(mouseY, target) {
      const rect = target.getBoundingClientRect();
      const relativeY = (mouseY - rect.top) / rect.height;
      const isContainer = target.getAttribute('data-component-type') === 'container';
      
      // å®¹å™¨ç»„ä»¶çš„ç‰¹æ®Šå¤„ç† - æ‰©å¤§å†…éƒ¨æ”¾ç½®åŒºåŸŸ
      if (isContainer) {
        if (relativeY > 0.2 && relativeY < 0.8) { // æ‰©å¤§å†…éƒ¨æ”¾ç½®åŒºåŸŸ
          return 'inside';
        }
      }
      
      return relativeY < 0.5 ? 'before' : 'after';
    }

    function updateDropIndicator(target, mouseY) {
      if (!isValidDropTarget(target)) {
        removeDropIndicator();
        return null;
      }

      const indicator = createDropIndicator();
      const rect = target.getBoundingClientRect();
      const position = getDropPosition(mouseY, target);
      const isContainer = target.getAttribute('data-component-type') === 'container';
      
      // è®¾ç½®æŒ‡ç¤ºå™¨æ ·å¼å’Œä½ç½®
      switch (position) {
        case 'before':
          indicator.className = 'drop-indicator horizontal';
          indicator.style.top = `${rect.top}px`;
          indicator.style.left = `${rect.left}px`;
          indicator.style.width = `${rect.width}px`;
          target.classList.remove('drag-over');
          break;
          
        case 'after':
          indicator.className = 'drop-indicator horizontal';
          indicator.style.top = `${rect.bottom}px`;
          indicator.style.left = `${rect.left}px`;
          indicator.style.width = `${rect.width}px`;
          target.classList.remove('drag-over');
          break;
          
        case 'inside':
          if (isContainer) {
            indicator.className = 'drop-indicator container';
            indicator.style.top = `${rect.top}px`;
            indicator.style.left = `${rect.left}px`;
            indicator.style.width = `${rect.width}px`;
            indicator.style.height = `${rect.height}px`;
            target.classList.add('drag-over');
          } else {
            // å¦‚æœä¸æ˜¯å®¹å™¨ï¼Œé»˜è®¤æ”¾åœ¨åé¢
            indicator.className = 'drop-indicator horizontal';
            indicator.style.top = `${rect.bottom}px`;
            indicator.style.left = `${rect.left}px`;
            indicator.style.width = `${rect.width}px`;
            target.classList.remove('drag-over');
          }
          break;
      }
      
      return position;
    }

    function removeDropIndicator() {
      if (dropIndicator) {
        dropIndicator.remove();
        dropIndicator = null;
      }
    }

    // ä¿®æ”¹æ¸²æŸ“å‡½æ•°
    function renderComponents(components) {
      const app = document.getElementById('app');
      
      // ç”Ÿæˆç»„ä»¶ HTML
      function generateComponentHtml(component) {
        const config = componentConfigs[component.type];
        if (!config) return '';
        
        // å¤„ç†å­ç»„ä»¶
        if (component.children && component.children.length > 0) {
            component.childrenContent = component.children
                .map(child => generateComponentHtml(child))
                .join('');
        }
        
        const componentHtml = config.render(component);
        
        // è·å–æ­£ç¡®çš„èœå•é…ç½®
        const menuConfig = hoverMenuConfig[component.type] || hoverMenuConfig.default;
        const menuItems = window.isPreviewMode ? menuConfig.previewMode : menuConfig.editMode;
        
        // ç”Ÿæˆèœå• HTML
        const menuHtml = `
          <div class="hover-menu" data-menu-for="${component.id}">
            ${menuItems.map(item => `
              <div class="hover-menu-item" onclick="handleMenuAction('${item.action}', '${component.id}')">
                <span class="menu-icon">${item.icon}</span>
                <span class="menu-label">${item.label}</span>
              </div>
            `).join('')}
          </div>
        `;
        
        return `
          <div class="editor-component" 
               data-component-id="${component.id}"
               data-component-type="${component.type}"
               style="${styleObjectToString(component.style)}"
               onmouseenter="showHoverMenu('${component.id}')"
               onmouseleave="hideHoverMenu('${component.id}')">
            ${componentHtml}
            ${menuHtml}
          </div>
        `;
      }
      
      // æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
      const componentsHtml = components.map(generateComponentHtml).join('');
      app.innerHTML = `
        <div class="component-container">
          ${componentsHtml}
        </div>
      `;
      
      // åˆå§‹åŒ– petite-vue
      createApp({
        // å¯æ·»åŠ å…¨å±€çŠ¶æ€å’Œæ–¹æ³•
        selectComponent(id, event) {
          event.stopPropagation();
          window.parent.postMessage({
            type: 'componentSelected',
            componentId: id
          }, '*');
        }
      }).mount();

      // åœ¨æ¸²æŸ“å®Œæˆååˆå§‹åŒ–å®¹å™¨ç›‘å¬å™¨
      initContainerListeners();
    }

    // ä¸çˆ¶çª—å£é€šä¿¡
    window.addEventListener('message', (event) => {
        console.log(event)
      if (event.data.type === 'updateComponents') {
        renderComponents(event.data.components);
        initContainerListeners(); // ç¡®ä¿åœ¨æ›´æ–°åé‡æ–°ç»‘å®šäº‹ä»¶
      }
    });

    // æ¸²æŸ“ä¸ç±»å‹ç»„ä»¶çš„å†…å®¹
    function renderComponentContent(component) {
      const config = componentConfigs[component.type];
      return config ? config.render(component) : '';
    }

    // é€‰ä¸­ç»„ä»¶
    window.selectComponent = function(event, id) {
      if (isPreviewMode) return; // é¢„è§ˆæ¨¡å¼ä¸‹ä¸å…è®¸é€‰æ‹©
      
      event.stopPropagation();
      selectedComponentId = id;
      
      // ç§»é™¤æ‰€æœ‰å·²ï¿½ï¿½ä¸­çš„ç±»
      document.querySelectorAll('.editor-component').forEach(el => {
        el.classList.remove('selected');
      });
      
      // æ·»åŠ é€‰ä¸­ç±»
      const selectedElement = document.querySelector(`[data-component-id="${id}"]`);
      if (selectedElement) {
        selectedElement.classList.add('selected');
      }

      // é€šçŸ¥çˆ¶çª—å£
      window.parent.postMessage({
        type: 'componentSelected',
        componentId: id
      }, '*');
    }

    // å·¥å…·å‡½æ•°ï¼šæ ·å¼å¯¹è±¡è½¬å­—ç¬¦ä¸²
    function styleObjectToString(styleObj) {
      return Object.entries(styleObj)
        .map(([key, value]) => `${key}: ${value}`)
        .join('; ');
    }

    // æ·»åŠ æ‹–æ‹½äº‹ä»¶å¤„ç†
    window.addEventListener('DOMContentLoaded', () => {
      const app = document.getElementById('app');
      
      // å®šä¹‰æ‹–æ‹½çš„å‡½æ•°
      function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        app.classList.add('drag-over');
        
        // æ›´æ–°æ‹–æ‹½é¢„è§ˆå…ƒç´ ä½ç½®
        if (dragGhost) {
          dragGhost.style.left = `${e.clientX}px`;
          dragGhost.style.top = `${e.clientY}px`;
        }
        
        // é€šçŸ¥çˆ¶çª—å£
        window.parent.postMessage({
          type: 'iframe-dragover',
          clientX: e.clientX,
          clientY: e.clientY
        }, '*');
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        app.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        app.classList.remove('drag-over');
        
        // é€šçŸ¥çˆ¶çª—å£
        window.parent.postMessage({
          type: 'iframe-drop',
          clientX: e.clientX,
          clientY: e.clientY
        }, '*');
      }
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      app.addEventListener('dragover', handleDragOver);
      app.addEventListener('dragleave', handleDragLeave);
      app.addEventListener('drop', handleDrop);
    });

    // ç¡®ä¿ app å…ƒç´ ç‚¹å‡»äº‹ä»¶åœ¨ DOMContentLoaded ä¹‹åç»‘å®š
    window.addEventListener('DOMContentLoaded', () => {
      const app = document.getElementById('app');
      app.addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
          selectedComponentId = null;
          document.querySelectorAll('.editor-component').forEach(el => {
            el.classList.remove('selected');
          });
          window.parent.postMessage({
            type: 'componentSelected',
            componentId: null
          }, '*');
        }
      });
    });

    // ä¿®æ”¹å®¹å™¨æ‹–æ‹½å¤„ç†æ•°
    function handleContainerDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const target = e.target.closest('.editor-component');
      if (!target) {
        removeDropIndicator();
        return;
      }
      
      // æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„æ‹–æ‹½æ ·å¼
      clearDropTargetStyles();
      
      // è·å–æ”¾ç½®ä½ç½®
      const position = getDropPosition(e.clientY, target);
      
      // æ›´æ–°æŒ‡ç¤ºå™¨
      updateDropIndicator(target, e.clientY);
      
      // é€šçŸ¥çˆ¶çª—å£
      window.parent.postMessage({
        type: 'iframe-dragover',
        targetId: target.getAttribute('data-component-id'),
        position: position,
        clientX: e.clientX,
        clientY: e.clientY
      }, '*');
    }

    function handleContainerDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const container = e.target.closest('.editor-component');
      if (container) {
        container.classList.remove('drag-over');
      }
      
      removeDropIndicator();
    }

    function handleContainerDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const target = e.target.closest('.editor-component');
      if (!target) {
        removeDropIndicator();
        return;
      }
      
      // è·å–æ”¾ç½®ä½ç½®
      const position = getDropPosition(e.clientY, target);
      
      // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ ·å¼å’ŒæŒ‡ç¤ºå™¨
      clearDropTargetStyles();
      removeDropIndicator();
      
      // é€šçŸ¥çˆ¶çª—å£,æ·»åŠ  containerId å‚æ•°
      window.parent.postMessage({
        type: 'iframe-drop',
        containerId: target.getAttribute('data-component-id'), // æ·»åŠ å®¹å™¨ID
        position: position,
        clientX: e.clientX,
        clientY: e.clientY,
        isContainer: target.getAttribute('data-component-type') === 'container'
      }, '*');
    }

    // ç¡®ä¿æ¸…ç†å‡½æ•°æ­£ç¡®æ‰§è¡Œ
    function clearDropTargetStyles() {
      document.querySelectorAll('.editor-component').forEach(el => {
        el.classList.remove('drag-over');
      });
    }

    // ä¿®æ”¹åˆå§‹åŒ–å®¹å™¨ç›‘å¬å™¨å‡½æ•°
    function initContainerListeners() {
      // ä¸ºæ‰€æœ‰ç»„ä»¶æ·»åŠ æ‹–æ‹½ç›‘å¬å™¨ï¼Œä¸ä»…ä»…æ˜¯å®¹å™¨
      document.querySelectorAll('.editor-component').forEach(component => {
        component.addEventListener('dragover', handleContainerDragOver);
        component.addEventListener('dragleave', handleContainerDragLeave);
        component.addEventListener('drop', handleContainerDrop);
      });
    }

    // ä¿®æ”¹æ ·å¼
    document.head.querySelector('style').textContent += `
      .editor-component[data-component-type="container"] {
        min-height: 50px;
        padding: 16px;
        border: 1px dashed #ddd;
        transition: all 0.2s ease;
      }

      .editor-component[data-component-type="container"].drag-over {
        border: 2px dashed #1890ff;
        background: rgba(24, 144, 255, 0.05);
        box-shadow: inset 0 0 8px rgba(24, 144, 255, 0.1);
      }

      .drop-indicator {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        transition: all 0.2s ease;
      }

      .drop-indicator.horizontal {
        height: 2px;
        background: #1890ff;
        box-shadow: 0 0 4px rgba(24, 144, 255, 0.5);
      }

      .drop-indicator.container {
        position: absolute;
        border: 2px dashed #1890ff;
        background: rgba(24, 144, 255, 0.05);
        pointer-events: none;
      }
    `;

    // ç¡®ä¿åœ¨ç»„ä»¶æ›´æ–°åé‡æ–°ç»‘å®šäº‹ä»¶
    window.addEventListener('message', (event) => {
      if (event.data.type === 'updateComponents') {
        // ç­‰å¾… DOM æ›´æ–°å®Œæˆåå†ç»‘å®šäº‹ä»¶
        setTimeout(() => {
          initContainerListeners();
        }, 0);
      }
    });

    // æ·»åŠ æ‹–æ‹½é¢„è§ˆå…ƒç´ å¤„ç†

    function createDragGhost(componentType) {
      const config = componentConfigs[componentType];
      if (!config) return;

      // åˆ›å»ºé¢„è§ˆå…ƒç´ 
      dragGhost = document.createElement('div');
      dragGhost.className = 'drag-ghost';
      
      // ä½¿ç”¨ç»„ä»¶é…ç½®çš„é»˜è®¤æ ·å¼
      const defaultStyle = config.defaultStyle;
      Object.assign(dragGhost.style, defaultStyle);
      
      // æ¸²æŸ“ç»„ä»¶é¢„è§ˆå†…å®¹
      const previewComponent = {
        type: componentType,
        props: config.defaultProps,
        style: config.defaultStyle
      };
      dragGhost.innerHTML = config.render(previewComponent);
      
      document.body.appendChild(dragGhost);
    }

    // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ‹–æ‹½å¼€å§‹æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      if (event.data.type === 'dragStart') {
        createDragGhost(event.data.componentType);
      } else if (event.data.type === 'dragEnd') {
        if (dragGhost) {
          dragGhost.remove();
          dragGhost = null;
        }
      }
    });

    // æ·»åŠ è¡Œä¸ºå¤„ç†å‡½æ•°
    window.handleBehavior = function(type, event, domEvent, behaviorData) {
      const behavior = behaviors[type];
      if (behavior?.events[event]?.handler) {
        let params = {};
        if (typeof behaviorData === 'string') {
          try {
            params = JSON.parse(behaviorData);
          } catch (error) {
            console.error('Error parsing behavior data:', error);
          }
        }
        behavior.events[event].handler(params, domEvent.target, domEvent);
      }
    };

    // ç›‘å¬æ¶ˆæ¯å¤„ç†
    window.addEventListener('message', (event) => {
        switch(event.data.type) {
            case 'updateMode':
                window.isPreviewMode = event.data.isPreviewMode;
                // æ›´æ–°æ‰€æœ‰ç»„ä»¶çš„äº¤äº’çŠ¶æ€
                document.querySelectorAll('.editor-component').forEach(el => {
                    if (isPreviewMode) {
                        el.classList.remove('selected');
                        el.classList.remove('editor-component');
                    } else {
                        el.classList.add('editor-component');
                    }
                });
                // æ›´æ–°bodyç±»
                document.body.classList.toggle('preview-mode', isPreviewMode);
                break;
                
        }
    });

    // ä¿®æ”¹æ ·å¼ (åˆ é™¤é‡å¤çš„styleå£°æ˜)
    const previewModeStyle = `
        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .editor-component {
            position: relative;
            cursor: pointer;
        }
        
        .editor-component:not(.preview-mode):hover {
            outline: 2px solid #1890ff;
        }
        
        /* é¢„è§ˆæ¨¡å¼æ ·å¼ */
        body.preview-mode .editor-component {
            cursor: default;
            outline: none !important;
        }
        
        body.preview-mode .editor-component:hover {
            outline: none !important;
        }
    `;

    // æ·»åŠ é¢„è§ˆæ¨¡å¼æ ·å¼
    const styleElement = document.createElement('style');
    styleElement.textContent = previewModeStyle;
    document.head.appendChild(styleElement);

    // æ·»åŠ æ‚¬æµ®èœå•å¤„ç†é€»è¾‘
    function createHoverMenu(component) {
      const menu = document.createElement('div');
      menu.className = 'hover-menu';
      
      const menuItems = window.isPreviewMode ? 
        hoverMenuConfig[component.type]?.previewMode : 
        hoverMenuConfig[component.type]?.editMode;

      if (!menuItems) return null;

      menuItems.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = 'hover-menu-item';
        menuItem.innerHTML = `
          <span class="menu-icon">${item.icon}</span>
          <span class="menu-label">${item.label}</span>
        `;
        
        menuItem.addEventListener('click', (e) => {
          e.stopPropagation();
          handleMenuAction(item.action, component.id);
        });
        
        menu.appendChild(menuItem);
      });

      return menu;
    }

    // ä¿®æ”¹èœå•æ“ä½œå¤„ç†å‡½æ•°ï¼Œæ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
    window.handleMenuAction = function(action, componentId) {
      // é˜»æ­¢äº‹ä»¶å†’æ³¡
      event?.stopPropagation();
      
      // å¯¹åˆ é™¤æ“ä½œæ·»åŠ ç¡®è®¤
      if (action === 'delete') {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç»„ä»¶å—ï¼Ÿ')) {
          // å‘çˆ¶çª—å£å‘é€èœå•æ“ä½œæ¶ˆæ¯
          window.parent.postMessage({
            type: 'menuAction',
            action,
            componentId
          }, '*');
        }
      } else {
        // å…¶ä»–æ“ä½œç›´æ¥å‘é€æ¶ˆæ¯
        window.parent.postMessage({
          type: 'menuAction',
          action,
          componentId
        }, '*');
      }
    }

    // æ·»åŠ æ˜¾ç¤º/éšè—æ‚¬æµ®èœå•çš„å‡½æ•°
    window.showHoverMenu = function(componentId) {
      const component = document.querySelector(`[data-component-id="${componentId}"]`);
      const menu = component?.querySelector('.hover-menu');
      if (menu) {
        menu.classList.add('visible');
      }
    }

    window.hideHoverMenu = function(componentId) {
      const component = document.querySelector(`[data-component-id="${componentId}"]`);
      const menu = component?.querySelector('.hover-menu');
      if (menu) {
        menu.classList.remove('visible');
      }
    }

    // æ·»åŠ å¯¼å‡ºé¡µé¢å†…å®¹çš„å‡½æ•°
    window.exportPageContent = function() {
      const app = document.getElementById('app');
      
      // åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´çš„DOMå…ƒç´ 
      const exportContent = app.cloneNode(true);
      
      // ç§»é™¤æ‰€æœ‰ç¼–è¾‘ç›¸å…³çš„å±æ€§å’Œå…ƒç´ 
      const elementsToClean = exportContent.getElementsByClassName('editor-component');
      Array.from(elementsToClean).forEach(element => {
        // ç§»é™¤æ‰€æœ‰ç¼–è¾‘ç›¸å…³ç±»
        element.classList.remove('editor-component', 'selected', 'highlight');
        
        // ç§»é™¤æ‰€æœ‰ç¼–è¾‘ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨æ€§
        element.removeAttribute('onmouseenter');
        element.removeAttribute('onmouseleave');
        element.removeAttribute('onclick');
        
        // ç§»é™¤æ‰€æœ‰ç¼–è¾‘ç›¸å…³çš„æ•°æ®å±æ€§ï¼Œä½†ä¿ç•™ç»„ä»¶ç±»å‹
        const componentType = element.getAttribute('data-component-type');
        element.removeAttribute('data-component-id');
        if (componentType) {
          element.setAttribute('data-type', componentType);
        }
        element.removeAttribute('data-component-type');
        
        // ç§»é™¤æ‚¬æµ®èœå•
        const menu = element.querySelector('.hover-menu');
        if (menu) {
          menu.remove();
        }
      });
      
      // ç”Ÿæˆå®Œæ•´çš„HTMLæ–‡æ¡£
      const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      margin: 0; 
      padding: 0; 
    }
    #app {
      width: 100%;
      min-height: 100vh;
      padding: 24px;
      box-sizing: border-box;
      max-width: 1200px;
      margin: 0 auto;
    }
    .component-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
  </style>
</head>
<body>
  ${exportContent.outerHTML}
</body>
</html>`;

      return htmlContent;
    };

    // æ·»åŠ å¯¼å‡ºå¤„ç†å‡½æ•°
    window.handleExport = function() {
      const htmlContent = window.exportPageContent();
      
      // é€šçŸ¥çˆ¶çª—å£
      window.parent.postMessage({
        type: 'exportPage',
        content: htmlContent
      }, '*');
    }

    // æ·»åŠ é˜²æŠ–å‡½æ•°æ¥ä¼˜åŒ–æ€§èƒ½
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // åˆ é™¤é‡å¤çš„æ ·å¼å£°æ˜ï¼Œæ”¹ä¸ºæ·»åŠ æ–°çš„æ ·å¼è§„åˆ™
    document.head.querySelector('style').textContent += `
      .drop-indicator {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        transition: all 0.1s ease;
      }
      
      .drop-indicator.horizontal {
        height: 2px;
        background: #1890ff;
        box-shadow: 0 0 4px rgba(24, 144, 255, 0.5);
      }
      
      .drop-indicator.container {
        border: 2px dashed #1890ff;
        background: rgba(24, 144, 255, 0.05);
        box-shadow: 0 0 8px rgba(24, 144, 255, 0.1);
        pointer-events: none;
      }
      
      .editor-component.drag-over {
        background: rgba(24, 144, 255, 0.05);
      }
    `;
  </script>
</body>
</html>