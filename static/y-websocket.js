/* esm.sh - y-websocket@2.1.0 */
import __Process$ from "./node_process.js";
import { Buffer as __Buffer$ } from "./buffer.js";
import"./yjs.js";var d=()=>new Map;var M=(t,e,s)=>{let n=t.get(e);return n===void 0&&t.set(e,n=s()),n};var P=()=>new Set;var et=Array.from;var Ze=Array.isArray;var st=String.fromCharCode,Je=String.fromCodePoint,Ke=st(65535),le=t=>t.toLowerCase(),pe=/^\s*/g,fe=t=>t.replace(pe,""),he=/([A-Z])/g,nt=(t,e)=>fe(t.replace(he,s=>`${e}${le(s)}`));var ue=t=>{let e=unescape(encodeURIComponent(t)),s=e.length,n=new Uint8Array(s);for(let o=0;o<s;o++)n[o]=e.codePointAt(o);return n},_=typeof TextEncoder<"u"?new TextEncoder:null,ge=t=>_.encode(t),Tt=_?ge:ue;var T=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});T&&T.decode(new Uint8Array).length===1&&(T=null);var ot=t=>t===void 0?null:t;var rt=class{constructor(){this.map=new Map}setItem(e,s){this.map.set(e,s)}getItem(e){return this.map.get(e)}},_t=new rt,it=!0;try{typeof localStorage<"u"&&localStorage&&(_t=localStorage,it=!1)}catch{}var j=_t,Bt=t=>it||addEventListener("storage",t),Ct=t=>it||removeEventListener("storage",t);var de=Object.keys;var Et=(t,e)=>{let s=[];for(let n in t)s.push(e(t[n],n));return s},ct=t=>de(t).length;var kt=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var ye=(t,e)=>t===e;var B=(t,e)=>{if(t==null||e==null)return ye(t,e);if(t.constructor!==e.constructor)return!1;if(t===e)return!0;switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;break}case Set:{if(t.size!==e.size)return!1;for(let s of t)if(!e.has(s))return!1;break}case Map:{if(t.size!==e.size)return!1;for(let s of t.keys())if(!e.has(s)||!B(t.get(s),e.get(s)))return!1;break}case Object:if(ct(t)!==ct(e))return!1;for(let s in t)if(!kt(t,s)||!B(t[s],e[s]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!B(t[s],e[s]))return!1;break;default:return!1}return!0},Mt=(t,e)=>e.includes(t);var U=typeof __Process$<"u"&&__Process$.release&&/node|io\.js/.test(__Process$.release.name)&&Object.prototype.toString.call(typeof __Process$<"u"?__Process$:0)==="[object process]",pt=typeof window<"u"&&typeof document<"u"&&!U,es=typeof navigator<"u"?/Mac/.test(navigator.platform):!1,w,xe=[],we=()=>{if(w===void 0)if(U){w=d();let t=__Process$.argv,e=null;for(let s=0;s<t.length;s++){let n=t[s];n[0]==="-"?(e!==null&&w.set(e,""),e=n):e!==null?(w.set(e,n),e=null):xe.push(n)}e!==null&&w.set(e,"")}else typeof location=="object"?(w=d(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){let[e,s]=t.split("=");w.set(`--${nt(e,"-")}`,s),w.set(`-${nt(e,"-")}`,s)}})):w=d();return w},at=t=>we().has(t);var lt=t=>U?ot(__Process$.env[t.toUpperCase().replaceAll("-","_")]):ot(j.getItem(t));var Lt=t=>at("--"+t)||lt(t)!==null,ss=Lt("production"),be=U&&Mt(__Process$.env.FORCE_COLOR,["true","1","2"]),ns=be||!at("--no-colors")&&!Lt("no-color")&&(!U||__Process$.stdout.isTTY)&&(!U||at("--color")||lt("COLORTERM")!==null||(lt("TERM")||"").includes("color"));var C=Math.floor;var R=(t,e)=>t<e?t:e,Dt=(t,e)=>t>e?t:e,os=Number.isNaN,Ot=Math.pow;var jt=Number.MAX_SAFE_INTEGER,rs=Number.MIN_SAFE_INTEGER,is=1<<31;var cs=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&C(t)===t),as=Number.isNaN,ls=Number.parseInt;var ht=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},p=()=>new ht;var q=t=>{let e=t.cpos;for(let s=0;s<t.bufs.length;s++)e+=t.bufs[s].length;return e};var a=t=>{let e=new Uint8Array(q(t)),s=0;for(let n=0;n<t.bufs.length;n++){let o=t.bufs[n];e.set(o,s),s+=o.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),s),e};var v=(t,e)=>{let s=t.cbuf.length;t.cpos===s&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(s*2),t.cpos=0),t.cbuf[t.cpos++]=e};var i=(t,e)=>{for(;e>127;)v(t,128|127&e),e=C(e/128);v(t,127&e)};var ut=new Uint8Array(3e4),Ae=ut.length/3,Ie=(t,e)=>{if(e.length<Ae){let s=_.encodeInto(e,ut).written||0;i(t,s);for(let n=0;n<s;n++)v(t,ut[n])}else y(t,Tt(e))},Te=(t,e)=>{let s=unescape(encodeURIComponent(e)),n=s.length;i(t,n);for(let o=0;o<n;o++)v(t,s.codePointAt(o))},Rt=_&&_.encodeInto?Ie:Te;var _e=(t,e)=>{let s=t.cbuf.length,n=t.cpos,o=R(s-n,e.length),r=e.length-o;t.cbuf.set(e.subarray(0,o),n),t.cpos+=o,r>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(Dt(s*2,r)),t.cbuf.set(e.subarray(o)),t.cpos=r)},y=(t,e)=>{i(t,e.byteLength),_e(t,e)};var hs=new DataView(new ArrayBuffer(4));var mt=t=>new Error(t);var Ce=mt("Unexpected end of array"),Ve=mt("Integer out of Range"),dt=class{constructor(e){this.arr=e,this.pos=0}},z=t=>new dt(t);var Ee=(t,e)=>{let s=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,s},V=t=>Ee(t,m(t));var Ht=t=>t.arr[t.pos++];var m=t=>{let e=0,s=1,n=t.arr.length;for(;t.pos<n;){let o=t.arr[t.pos++];if(e=e+(o&127)*s,s*=128,o<128)return e;if(e>jt)throw Ve}throw Ce};var ke=t=>{let e=m(t);if(e===0)return"";{let s=String.fromCodePoint(Ht(t));if(--e<100)for(;e--;)s+=String.fromCodePoint(Ht(t));else for(;e>0;){let n=e<1e4?e:1e4,o=t.arr.subarray(t.pos,t.pos+n);t.pos+=n,s+=String.fromCodePoint.apply(null,o),e-=n}return decodeURIComponent(escape(s))}},Ne=t=>T.decode(V(t)),Y=T?Ne:ke;var Me=t=>new Uint8Array(t),Pe=(t,e,s)=>new Uint8Array(t,e,s),vt=t=>new Uint8Array(t),Le=t=>{let e="";for(let s=0;s<t.byteLength;s++)e+=st(t[s]);return btoa(e)},Fe=t=>__Buffer$.from(t.buffer,t.byteOffset,t.byteLength).toString("base64"),De=t=>{let e=atob(t),s=Me(e.length);for(let n=0;n<e.length;n++)s[n]=e.charCodeAt(n);return s},Oe=t=>{let e=__Buffer$.from(t,"base64");return Pe(e.buffer,e.byteOffset,e.byteLength)},qt=pt?Le:Fe,zt=pt?De:Oe;var Yt=new Map,yt=class{constructor(e){this.room=e,this.onmessage=null,this._onChange=s=>s.key===e&&this.onmessage!==null&&this.onmessage({data:zt(s.newValue||"")}),Bt(this._onChange)}postMessage(e){j.setItem(this.room,qt(vt(e)))}close(){Ct(this._onChange)}},Re=typeof BroadcastChannel>"u"?yt:BroadcastChannel,xt=t=>M(Yt,t,()=>{let e=P(),s=new Re(t);return s.onmessage=n=>e.forEach(o=>o(n.data,"broadcastchannel")),{bc:s,subs:e}}),$t=(t,e)=>(xt(t).subs.add(e),e),Gt=(t,e)=>{let s=xt(t),n=s.subs.delete(e);return n&&s.subs.size===0&&(s.bc.close(),Yt.delete(t)),n},A=(t,e,s=null)=>{let n=xt(t);n.bc.postMessage(e),n.subs.forEach(o=>o(e,s))};var S=Date.now;import*as E from"./yjs.js";var Wt=0,G=1,Xt=2,Q=(t,e)=>{i(t,Wt);let s=E.encodeStateVector(e);y(t,s)},wt=(t,e,s)=>{i(t,G),y(t,E.encodeStateAsUpdate(e,s))},ve=(t,e,s)=>wt(e,s,V(t)),Zt=(t,e,s)=>{try{E.applyUpdate(e,V(t),s)}catch(n){console.error("Caught error while handling a Yjs update",n)}},Jt=(t,e)=>{i(t,Xt),y(t,e)},qe=Zt,Kt=(t,e,s,n)=>{let o=m(t);switch(o){case Wt:ve(t,e,s);break;case G:Zt(t,s,n);break;case Xt:qe(t,s,n);break;default:throw new Error("Unknown message type")}return o};import"./yjs.js";var Ye=0;var te=(t,e,s)=>{switch(m(t)){case Ye:s(e,Y(t))}};var W=class{constructor(){this._observers=d()}on(e,s){return M(this._observers,e,P).add(s),s}once(e,s){let n=(...o)=>{this.off(e,n),s(...o)};this.on(e,n)}off(e,s){let n=this._observers.get(e);n!==void 0&&(n.delete(s),n.size===0&&this._observers.delete(e))}emit(e,s){return et((this._observers.get(e)||d()).values()).forEach(n=>n(...s))}destroy(){this._observers=d()}},X=class{constructor(){this._observers=d()}on(e,s){M(this._observers,e,P).add(s)}once(e,s){let n=(...o)=>{this.off(e,n),s(...o)};this.on(e,n)}off(e,s){let n=this._observers.get(e);n!==void 0&&(n.delete(s),n.size===0&&this._observers.delete(e))}emit(e,s){return et((this._observers.get(e)||d()).values()).forEach(n=>n(...s))}destroy(){this._observers=d()}};import"./yjs.js";var bt=3e4,Z=class extends X{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let s=S();this.getLocalState()!==null&&bt/2<=s-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let n=[];this.meta.forEach((o,r)=>{r!==this.clientID&&bt<=s-o.lastUpdated&&this.states.has(r)&&n.push(r)}),n.length>0&&J(this,n,"timeout")},C(bt/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){let s=this.clientID,n=this.meta.get(s),o=n===void 0?0:n.clock+1,r=this.states.get(s);e===null?this.states.delete(s):this.states.set(s,e),this.meta.set(s,{clock:o,lastUpdated:S()});let c=[],x=[],f=[],b=[];e===null?b.push(s):r==null?e!=null&&c.push(s):(x.push(s),B(r,e)||f.push(s)),(c.length>0||f.length>0||b.length>0)&&this.emit("change",[{added:c,updated:f,removed:b},"local"]),this.emit("update",[{added:c,updated:x,removed:b},"local"])}setLocalStateField(e,s){let n=this.getLocalState();n!==null&&this.setLocalState({...n,[e]:s})}getStates(){return this.states}},J=(t,e,s)=>{let n=[];for(let o=0;o<e.length;o++){let r=e[o];if(t.states.has(r)){if(t.states.delete(r),r===t.clientID){let c=t.meta.get(r);t.meta.set(r,{clock:c.clock+1,lastUpdated:S()})}n.push(r)}}n.length>0&&(t.emit("change",[{added:[],updated:[],removed:n},s]),t.emit("update",[{added:[],updated:[],removed:n},s]))},k=(t,e,s=t.states)=>{let n=e.length,o=p();i(o,n);for(let r=0;r<n;r++){let c=e[r],x=s.get(c)||null,f=t.meta.get(c).clock;i(o,c),i(o,f),Rt(o,JSON.stringify(x))}return a(o)};var ee=(t,e,s)=>{let n=z(e),o=S(),r=[],c=[],x=[],f=[],b=m(n);for(let F=0;F<b;F++){let h=m(n),l=m(n),u=JSON.parse(Y(n)),g=t.meta.get(h),At=t.states.get(h),D=g===void 0?0:g.clock;(D<l||D===l&&u===null&&t.states.has(h))&&(u===null?h===t.clientID&&t.getLocalState()!=null?l++:t.states.delete(h):t.states.set(h,u),t.meta.set(h,{clock:l,lastUpdated:o}),g===void 0&&u!==null?r.push(h):g!==void 0&&u===null?f.push(h):u!==null&&(B(u,At)||x.push(h),c.push(h)))}(r.length>0||x.length>0||f.length>0)&&t.emit("change",[{added:r,updated:x,removed:f},s]),(r.length>0||c.length>0||f.length>0)&&t.emit("update",[{added:r,updated:c,removed:f},s])};var se=t=>Et(t,(e,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(e)}`).join("&");var I=0,re=3,N=1,We=2,L=[];L[I]=(t,e,s,n,o)=>{i(t,I);let r=Kt(e,t,s.doc,s);n&&r===G&&!s.synced&&(s.synced=!0)};L[re]=(t,e,s,n,o)=>{i(t,N),y(t,k(s.awareness,Array.from(s.awareness.getStates().keys())))};L[N]=(t,e,s,n,o)=>{ee(s.awareness,V(e),s)};L[We]=(t,e,s,n,o)=>{te(e,s.doc,(r,c)=>Xe(s,c))};var ne=3e4,Xe=(t,e)=>console.warn(`Permission denied to access ${t.url}.
${e}`),ie=(t,e,s)=>{let n=z(e),o=p(),r=m(n),c=t.messageHandlers[r];return c?c(o,n,t,s,r):console.error("Unable to compute message"),o},St=(t,e,s)=>{e===t.ws&&(t.emit("connection-close",[s,t]),t.ws=null,e.close(),t.wsconnecting=!1,t.wsconnected?(t.wsconnected=!1,t.synced=!1,J(t.awareness,Array.from(t.awareness.getStates().keys()).filter(n=>n!==t.doc.clientID),t),t.emit("status",[{status:"disconnected"}])):t.wsUnsuccessfulReconnects++,setTimeout(ce,R(Ot(2,t.wsUnsuccessfulReconnects)*100,t.maxBackoffTime),t))},ce=t=>{if(t.shouldConnect&&t.ws===null){let e=new t._WS(t.url,t.protocols);e.binaryType="arraybuffer",t.ws=e,t.wsconnecting=!0,t.wsconnected=!1,t.synced=!1,e.onmessage=s=>{t.wsLastMessageReceived=S();let n=ie(t,new Uint8Array(s.data),!0);q(n)>1&&e.send(a(n))},e.onerror=s=>{t.emit("connection-error",[s,t])},e.onclose=s=>{St(t,e,s)},e.onopen=()=>{t.wsLastMessageReceived=S(),t.wsconnecting=!1,t.wsconnected=!0,t.wsUnsuccessfulReconnects=0,t.emit("status",[{status:"connected"}]);let s=p();if(i(s,I),Q(s,t.doc),e.send(a(s)),t.awareness.getLocalState()!==null){let n=p();i(n,N),y(n,k(t.awareness,[t.doc.clientID])),e.send(a(n))}},t.emit("status",[{status:"connecting"}])}},Ut=(t,e)=>{let s=t.ws;t.wsconnected&&s&&s.readyState===s.OPEN&&s.send(e),t.bcconnected&&A(t.bcChannel,e,t)},oe=class extends W{constructor(e,s,n,{connect:o=!0,awareness:r=new Z(n),params:c={},protocols:x=[],WebSocketPolyfill:f=WebSocket,resyncInterval:b=-1,maxBackoffTime:F=2500,disableBc:h=!1}={}){for(super();e[e.length-1]==="/";)e=e.slice(0,e.length-1);this.serverUrl=e,this.bcChannel=e+"/"+s,this.maxBackoffTime=F,this.params=c,this.protocols=x,this.roomname=s,this.doc=n,this._WS=f,this.awareness=r,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=L.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=o,this._resyncInterval=0,b>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){let l=p();i(l,I),Q(l,n),this.ws.send(a(l))}},b)),this._bcSubscriber=(l,u)=>{if(u!==this){let g=ie(this,new Uint8Array(l),!1);q(g)>1&&A(this.bcChannel,a(g),this)}},this._updateHandler=(l,u)=>{if(u!==this){let g=p();i(g,I),Jt(g,l),Ut(this,a(g))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:l,updated:u,removed:g},At)=>{let D=l.concat(u).concat(g),K=p();i(K,N),y(K,k(r,D)),Ut(this,a(K))},this._exitHandler=()=>{J(this.awareness,[n.clientID],"app closed")},U&&typeof __Process$<"u"&&__Process$.on("exit",this._exitHandler),r.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&ne<S()-this.wsLastMessageReceived&&St(this,this.ws,null)},ne/10),o&&this.connect()}get url(){let e=se(this.params);return this.serverUrl+"/"+this.roomname+(e.length===0?"":"?"+e)}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),U&&typeof __Process$<"u"&&__Process$.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||($t(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);let e=p();i(e,I),Q(e,this.doc),A(this.bcChannel,a(e),this);let s=p();i(s,I),wt(s,this.doc),A(this.bcChannel,a(s),this);let n=p();i(n,re),A(this.bcChannel,a(n),this);let o=p();i(o,N),y(o,k(this.awareness,[this.doc.clientID])),A(this.bcChannel,a(o),this)}disconnectBc(){let e=p();i(e,N),y(e,k(this.awareness,[this.doc.clientID],new Map)),Ut(this,a(e)),this.bcconnected&&(Gt(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&St(this,this.ws,null)}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(ce(this),this.connectBc())}};export{oe as WebsocketProvider,We as messageAuth,N as messageAwareness,re as messageQueryAwareness,I as messageSync};
//# sourceMappingURL=y-websocket.bundle.mjs.map